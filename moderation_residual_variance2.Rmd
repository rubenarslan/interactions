# Differences in slopes or residual variance

```{r}
library(tidyverse)
library(brms)
```



### Data-generating model
```{r}
n <- 50
days_per_person <- 120
n_days <- n*days_per_person
set.seed(20191005)
people <- tibble(
  id = 1:n,
  average_job_satisfaction = rnorm(n),
  average_productivity = rnorm(n, mean = 5, 2)
)

diary <-  people %>% full_join(
  tibble(
    id = rep(1:n, each = days_per_person),
  ), by = 'id') %>% 
  mutate(
    day_number = rep(1:days_per_person, each = n),
    parent = day_number > 60,
    Job_satisfaction = 0.8 * average_job_satisfaction + 0.6 * rnorm(n_days),
    Sleep = rnorm(n*days_per_person),
    DiaperMayhem = rnorm(n*days_per_person),
    Teething = rnorm(n*days_per_person),
    residual = rnorm(n_days)
  )
sd(diary$Job_satisfaction)
sd(diary$residual)
```

## Model 0: Main effect only
```{r}
diary <- diary %>% 
  mutate(
    OWB = 0.5 * Job_satisfaction + 0.5*average_well_being + 0.7 * residual
  )
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction, OWB))) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor))))
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction*single_f + (1 + Job_satisfaction | id), data = diary, cores = 4, backend = "cmdstanr", file = "main_only")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)


ggplot(diary, aes(Job_satisfaction, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+   geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
```


## Model 1: Slopes differ
```{r}
diary <- diary %>% 
  mutate(
    OWB = if_else(single == 1, 0.6, 0.4) * Job_satisfaction + 0.5*average_well_being + 0.7 * residual
  )
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction, OWB))) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor))))
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction*single_f + (1 + Job_satisfaction | id), data = diary, cores = 4, backend = "cmdstanr", file = "slopes_differ")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)


m1 <- ggplot(diary, aes(Job_satisfaction, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+   geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
m1
```

## Model 2: Correlations, not slopes differ
```{r}
diary <- diary %>% 
  mutate(
    OWB = 0.5 * Job_satisfaction + 0.5*average_well_being + if_else(single == 1, 0, 0.7) * Relationship_satisfaction + 0.45 * residual
  )
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction, OWB))) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor))))
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction*single_f + (1 + Job_satisfaction | id), data = diary, cores = 4, backend = "cmdstanr", file = "corrs_differ_not_slopes")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)


m2 <- ggplot(diary, aes(Job_satisfaction, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+  geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
m2
```

## Model 3: Restricted variance in predictor and outcome
```{r}
diary <- diary %>% 
  mutate(
    Job_satisfaction2 = if_else(single == 1, Job_satisfaction / 1.3 + 1, Job_satisfaction * 1.08),
    OWB = 0.5 * Job_satisfaction2 + 0.5*average_well_being + if_else(single == 1, 0, 0.7) * Relationship_satisfaction + 0.45 * residual
  )
diary %>% group_by(single_f, id) %>%
  summarise(cor = cor(Job_satisfaction, OWB)) %>% 
  summarise(mean(cor))

sd(diary$Job_satisfaction)
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction2, OWB))) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor))))
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction2*single_f + (1 + Job_satisfaction2 | id), data = diary, cores = 4, backend = "cmdstanr", file = "restricted_variance")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)


m3 <- ggplot(diary, aes(Job_satisfaction2, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction2, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+
  geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
m3
```

## Model 4: Variance in outcome increases with moderator
```{r}
diary <- diary %>% 
  mutate(
    OWB_latent = 0.5 * Job_satisfaction + 0.5*average_well_being + 0.7 * residual,
    OWB =  if_else(single == 1, 1.3, 0.7) * OWB_latent
  )

sd(diary$Job_satisfaction)
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction, OWB))) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor))))
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction*single_f + (1 + Job_satisfaction | id), data = diary, cores = 4, backend = "cmdstanr", file = "dimmer")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)

m4 <- ggplot(diary, aes(Job_satisfaction, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+
  geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
m4
```

## Model 5: Variance in outcome increases with moderator, predictor variance is lower
```{r}
diary <- diary %>% 
  mutate(
    Job_satisfaction2 = if_else(single == 0, Job_satisfaction * 0.85 + 1, Job_satisfaction * 1.15),
    OWB = if_else(single == 1, 0.35, 0.4) * Job_satisfaction2 + 0.5*average_well_being + if_else(single == 1, 0, 0.4) * Relationship_satisfaction + 0.55 * residual
  )

sd(diary$Job_satisfaction2)
sd(diary$OWB)
round(cor(diary %>% select(single, Job_satisfaction, Relationship_satisfaction, OWB)),2)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(single_f, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction2, OWB)),
            var_owb = var(OWB),
            var_js = var(Job_satisfaction2)) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor)),
            sd_owb = sqrt(mean(var_owb)),
            sd_js = sqrt(mean(var_js)))
)
```

### Scatter plot
```{r}
model <- brm(OWB ~ Job_satisfaction2*single_f + (1 + Job_satisfaction2 | id), data = diary, cores = 4, backend = "cmdstanr", file = "mod_complex")
model2 <- brm(bf(OWB ~ Job_satisfaction2*single_f + (1 + Job_satisfaction2 | id),
                 sigma ~ single_f), data = diary, cores = 4, backend = "cmdstanr", file = "mod_complex2")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)

m5 <- ggplot(diary, aes(Job_satisfaction2, OWB)) +
  facet_wrap(~ single_f) +
  geom_point(alpha = 0.03, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  # geom_smooth(aes(Job_satisfaction2, OWB), method = 'lm', color = 'black') +
  geom_smooth(aes(Job_satisfaction2, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+
  geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=2.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Overall well-being") +
  ggthemes::theme_clean()
m5
ggsave("singles_slope_vs_corr.pdf", width = 4.5, height = 3)
ggsave("singles_slope_vs_corr.png", width = 4.5, height = 3)
```

## Model 6: Variance in outcome increases with moderator, predictor variance is lower

```{r}
diary <- diary %>% 
  mutate(
    Productivity = 5 - 1 * parent + if_else(parent, 0.4, 0.3) * Job_satisfaction + if_else(parent, 0.4 * Sleep - 0.3 * DiaperMayhem - 0.4 * Teething, 0) + 0.8 * residual
  )

sd(diary$Job_satisfaction)
qplot(diary$Productivity)
ggplot(data = diary) + geom_histogram(aes(Productivity, fill = parent), position = position_identity(), alpha = 0.4)
```

### Inspect correlations
```{r}
(cors <- diary %>% group_by(parent, id) %>%
  summarise(cor = psych::fisherz(cor(Job_satisfaction, Productivity)),
            slope = broom::tidy(lm(Productivity ~ Job_satisfaction))[2, "estimate"][[1]],
            residual = var(resid(lm(Productivity ~ Job_satisfaction))),
            var_prod = var(Productivity),
            mean_prod = mean(Productivity),
            max_js = max(Job_satisfaction),
            var_js = var(Job_satisfaction)) %>% 
  summarise(estimate = psych::fisherz2r(mean(cor)),
            slope = mean(slope),
            sd_resid = sqrt(mean(residual)),
            sd_prod = sqrt(mean(var_prod)),
            mean_prod = mean(mean_prod),
            max_js = max(max_js),
            sd_js = sqrt(mean(var_js)))
)
```

### Scatter plot
```{r}
model <- brm(Productivity ~ parent * Job_satisfaction + (1 + Job_satisfaction | id), data = diary, cores = 4, backend = "cmdstanr", file = "productivity_mod_complex")
model2 <- brm(bf(Productivity ~ parent * Job_satisfaction + (1 + Job_satisfaction | id),
                 sigma ~ single_f), data = diary, cores = 4, backend = "cmdstanr", file = "productivity_mod_complex_sigma")

diary[,c("estimate__", "std.error__", "lower__", "upper__")] <- fitted(model, re_formula = NA)

m6 <- ggplot(diary, aes(Job_satisfaction, Productivity)) +
  facet_wrap(~ parent, labeller = labeller(parent = c("TRUE" = "after parenthood", "FALSE" = "pre parenthood"))) +
  geom_point(alpha = 0.1, color = "#6E9181") +
  # geom_line(aes(color = factor(if_else(id > 25, id - 24.5, as.numeric(id)))), stat = "smooth", method = 'lm', alpha = 0.3) +
  geom_smooth(aes(Job_satisfaction, Productivity), method = 'lm', color = 'black') +
  # geom_smooth(aes(Job_satisfaction, estimate__, ymin = lower__, ymax = upper__), stat = 'identity', color = 'black') +
  scale_color_viridis_d(guide = F, option = "B")+
  geom_text(aes(label = sprintf('italic("r")==plain("%.2f")', estimate)), x= -2.5, y=7.5, data = cors, hjust = 0, parse = TRUE, size = 3) +
  geom_segment(aes(x = max_js, y = mean_prod - sd_prod, xend = max_js, , yend = mean_prod + sd_prod), data = cors, size = 1, color = "#219FD8") +
  # coord_cartesian(ylim = c(-3.5, 3.5)) +
  xlab("Job satisfaction") +
  ylab("Productivity (h)") +
  ggthemes::theme_clean()
m6

ggsave("singles_slope_vs_corr.pdf", width = 4.5, height = 3)
ggsave("singles_slope_vs_corr.png", width = 4.5, height = 3)
```

## Altogether
```{r}
library(cowplot)
plot_grid(m1, m2, m3, m4, ncol = 2, labels = "AUTO")
ggsave("job_satisfaction_singles.pdf", width = 5, height = 4)
ggsave("job_satisfaction_singles.png", width = 5, height = 4)
```

